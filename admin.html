<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración - Contactos</title>
  
  <!-- Bootstrap CSS: Framework de estilos para diseño responsive -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons: Iconos vectoriales -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
  <!--
    ============================================
    PANEL DE ADMINISTRACIÓN DE CONTACTOS
    ============================================
    
    Este panel permite:
    - Ver todos los contactos guardados en la base de datos
    - Actualizar la lista en tiempo real
    - Ver detalles completos de cada contacto
    
    FUNCIONALIDADES:
    - Carga automática al abrir la página
    - Botón de actualización manual
    - Tabla responsive con Bootstrap
    - Indicadores de carga
    - Manejo de estados vacíos
  -->
  <div class="container my-5">
    <h1 class="text-center mb-4">
      <i class="bi bi-people-fill"></i> Panel de Contactos
    </h1>
    
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista de Contactos</h5>
        <button class="btn btn-primary btn-sm" onclick="cargarContactos()">
          <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
      </div>
      <div class="card-body">
        <div id="loading" class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <div id="contactos-container" style="display: none;">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Teléfono</th>
                  <th>Mensaje</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="contactos-tbody">
              </tbody>
            </table>
          </div>
        </div>
        <div id="no-contactos" class="alert alert-info" style="display: none;">
          No hay contactos registrados aún.
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ============================================
     * SCRIPT DEL PANEL DE ADMINISTRACIÓN
     * ============================================
     * 
     * Este script maneja:
     * - Carga de contactos desde la API
     * - Renderizado dinámico de la tabla
     * - Estados de carga y vacío
     * - Actualización manual de datos
     */

    /**
     * FUNCIÓN: cargarContactos()
     * ==========================
     * Obtiene todos los contactos de la base de datos
     * y los muestra en una tabla HTML
     * 
     * FLUJO:
     * 1. Mostrar indicador de carga
     * 2. Hacer petición GET a la API
     * 3. Procesar respuesta
     * 4. Renderizar tabla o mensaje vacío
     * 5. Manejar errores
     */
    async function cargarContactos() {
      // ============================================
      // OBTENER REFERENCIAS A ELEMENTOS DEL DOM
      // ============================================
      const loading = document.getElementById('loading');           // Spinner de carga
      const container = document.getElementById('contactos-container'); // Contenedor de tabla
      const noContactos = document.getElementById('no-contactos');  // Mensaje vacío
      const tbody = document.getElementById('contactos-tbody');     // Cuerpo de la tabla
      
      // ============================================
      // MOSTRAR ESTADO DE CARGA
      // ============================================
      loading.style.display = 'block';      // Mostrar spinner
      container.style.display = 'none';     // Ocultar tabla
      noContactos.style.display = 'none';   // Ocultar mensaje vacío
      
      try {
        // ============================================
        // PETICIÓN A LA API
        // ============================================
        /**
         * Hace una petición GET al endpoint /api/contactos
         * El servidor responde con todos los contactos
         */
        const response = await fetch('/api/contactos');
        const data = await response.json();
        
        // Ocultar spinner de carga
        loading.style.display = 'none';
        
        // ============================================
        // PROCESAR RESPUESTA
        // ============================================
        if (data.success && data.contactos.length > 0) {
          // HAY CONTACTOS: Renderizar tabla
          
          // Limpiar contenido anterior
          tbody.innerHTML = '';
          
          /**
           * ITERAR SOBRE CADA CONTACTO
           * Crear una fila (tr) por cada contacto
           */
          data.contactos.forEach(contacto => {
            // Formatear fecha a formato local español
            const fecha = new Date(contacto.fecha_registro).toLocaleString('es-ES');
            
            /**
             * CREAR FILA HTML
             * - ID: Identificador único
             * - Nombre: Nombre del cliente
             * - Email: Link mailto para enviar correo
             * - Teléfono: Link tel para llamar
             * - Mensaje: Truncado a 50 caracteres
             * - Fecha: Fecha formateada
             */
            const row = `
              <tr>
                <td>${contacto.id}</td>
                <td>${contacto.nombre}</td>
                <td><a href="mailto:${contacto.email}">${contacto.email}</a></td>
                <td><a href="tel:${contacto.numero}">${contacto.numero}</a></td>
                <td>${contacto.mensaje.substring(0, 50)}${contacto.mensaje.length > 50 ? '...' : ''}</td>
                <td>${fecha}</td>
              </tr>
            `;
            
            // Agregar fila a la tabla
            tbody.innerHTML += row;
          });
          
          // Mostrar tabla
          container.style.display = 'block';
          
        } else {
          // NO HAY CONTACTOS: Mostrar mensaje
          noContactos.style.display = 'block';
        }
        
      } catch (error) {
        // ============================================
        // MANEJO DE ERRORES
        // ============================================
        /**
         * Este bloque se ejecuta si:
         * - El servidor no está corriendo
         * - Hay un error de red
         * - La respuesta no es válida
         */
        loading.style.display = 'none';
        alert('Error al cargar contactos: ' + error.message);
        console.error('❌ Error:', error);
      }
    }
    
    // ============================================
    // INICIALIZACIÓN
    // ============================================
    /**
     * Cargar contactos automáticamente cuando
     * la página termine de cargar
     */
    document.addEventListener('DOMContentLoaded', cargarContactos);
  </script>
</body>
</html>
